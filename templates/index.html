{% load static%}

<!DOCTYPE html>
<html>
    <head>
        <meta charset ="UTF-8">
        <title>Start</title>
        <link rel="stylesheet" href="{% static 'styleIndex.css' %}">
        <link rel="shortcut icon" type="image/png" href="{% static 'images/std-icon.png' %}">
        <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous">
        </script>
    </head>
    <body>        

        <div class="ui">
             
            <form id="start" action="/lobby" onsubmit="return validateForm();">  
                {% csrf_token %}              
                <input type="text" id="name" placeholder="Dein Name" pattern="[A-Za-z]+" oninput="setCustomValidity('')" method="POST"></input><br>                       
            </form>          

            <script>                                             
                
                const getSHA256Hash = async (input) => {
                    const textAsBuffer = new TextEncoder().encode(input);
                    const hashBuffer = await window.crypto.subtle.digest("SHA-256", textAsBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hash = hashArray
                        .map((item) => item.toString(16).padStart(2, "0"))
                        .join("");
                    return hash;
                };

                function validateForm(){                    
                    var name = document.getElementById('name');
                    
                    let empty = name.value == '';
                    let notValid = !name.checkValidity();
                    
                    if(empty || notValid){
                        alert("Please enter valid values for all boxes.");
                        return false;
                    }
                    return true;
                }

                $(function() {                    
                var csrftoken = getCookie('csrftoken');

                /*
                The functions below will create a header with csrftoken
                */

                function csrfSafeMethod(method) {
                    // these HTTP methods do not require CSRF protection
                    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                }
                function sameOrigin(url) {
                    // test that a given url is a same-origin URL
                    // url could be relative or scheme relative or absolute
                    var host = document.location.host; // host + port
                    var protocol = document.location.protocol;
                    var sr_origin = '//' + host;
                    var origin = protocol + sr_origin;
                    // Allow absolute or scheme relative URLs to same origin
                    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                        // or any other URL that isn't scheme relative or absolute i.e relative.
                        !(/^(\/\/|http:|https:).*/.test(url));
                }

                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                            // Send the token to same-origin, relative URLs only.
                            // Send the token only if the method warrants CSRF protection
                            // Using the CSRFToken value acquired earlier
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });

                });

                function getCookie(name) {
                    var cookieValue = null;
                    if (document.cookie && document.cookie != '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = jQuery.trim(cookies[i]);
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }

                $('#start').on('submit', async function(event){     
                    
                    var name = document.getElementById('name').value;

                    // TODO reset lobby when certain name is entered

                    userCookie = getCookie('userData');
                    if(userCookie == null){
                                            
                        const d = new Date();
                        let time = d.getTime();
                        var userID = await getSHA256Hash(name + time);
                        var userData = `{"playerName":"${name}", "playerID":"${userID}"}`;
                        document.cookie = `userData=${userData}` + ";" + "SameSite=Lax;";   
                        
                    // update playerName
                    }else if (JSON.parse(userCookie).playerName != name){

                        var userID = JSON.parse(userCookie).playerID;
                        var userData = `{"playerName":"${name}", "playerID":"${userID}"}`;
                        document.cookie = `userData=${userData}` + ";" + "SameSite=Lax;";   

                    }                                                                                     
                });
            </script>      
        </div> 

        <footer>
            <p> <a href="http://www.onlinewebfonts.com">Font By Online Web Fonts (Alisa Nowak) / </a> 
                Image by <a href="https://pixabay.com/users/felixmittermeier-4397258/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2463236">FelixMittermeier</a> from <a href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2463236">Pixabay</a></p>
        </footer>
        
    </body>
</html>

